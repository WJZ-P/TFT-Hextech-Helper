# TFT-Hextech-Helper 架构逻辑梳理

> 本文档梳理项目的整体架构、模块职责和运行流程，帮助理解代码逻辑。

---

## 一、项目整体架构

```
┌────────────────────────────────────────────────────────────────────┐
│                         Electron 应用                              │
├──────────────────────────┬─────────────────────────────────────────┤
│      渲染进程 (React)     │              主进程 (Node.js)           │
│                          │                                         │
│  ┌──────────────────┐    │    ┌─────────────────────────────────┐  │
│  │   HomePage.tsx   │    │    │         main.ts                 │  │
│  │   LineupPage.tsx │◄───┼───►│    (IPC Handler 注册)           │  │
│  │   SettingsPage   │    │    └─────────────┬───────────────────┘  │
│  └──────────────────┘    │                  │                      │
│           │              │                  ▼                      │
│           │              │    ┌─────────────────────────────────┐  │
│           │              │    │        src-backend/             │  │
│           ▼              │    │  ┌─────────┐  ┌──────────────┐  │  │
│  ┌──────────────────┐    │    │  │ States  │  │  Services    │  │  │
│  │   preload.ts     │    │    │  │ (状态机) │  │ (服务层)     │  │  │
│  │  (API 桥接层)    │────┼────│  └────┬────┘  └──────┬───────┘  │  │
│  │                  │    │    │       │             │           │  │
│  │  window.hex      │    │    │       ▼             ▼           │  │
│  │  window.tft      │    │    │  ┌─────────────────────────┐    │  │
│  │  window.lcu      │    │    │  │     TftOperator         │    │  │
│  │  window.lineup   │    │    │  │   (游戏操作接口层)       │    │  │
│  └──────────────────┘    │    │  └─────────────────────────┘    │  │
│                          │    └─────────────────────────────────┘  │
└──────────────────────────┴─────────────────────────────────────────┘
```

---

## 二、目录结构

```
TFT-Hextech-Helper/
├── electron/                      # Electron 主进程
│   ├── main.ts                    # 主进程入口，IPC Handler 注册
│   ├── preload.ts                 # 预加载脚本，暴露 API 给渲染进程
│   └── protocol.ts                # IPC 通信频道枚举定义
│
├── src/                           # 前端 React 应用
│   ├── components/
│   │   └── pages/
│   │       ├── HomePage.tsx       # 主页（启动/停止按钮）
│   │       ├── LineupPage.tsx     # 阵容选择页
│   │       └── SettingsPage.tsx   # 设置页
│   └── stores/                    # 前端状态管理
│
├── src-backend/                   # 后端核心逻辑
│   ├── states/                    # 状态机状态类
│   │   ├── IState.ts              # 状态接口
│   │   ├── IdleState.ts           # 空闲状态
│   │   ├── StartState.ts          # 启动状态
│   │   ├── LobbyState.ts          # 大厅状态
│   │   ├── GameLoadingState.ts    # 游戏加载状态
│   │   ├── GameStageState.ts      # 游戏阶段状态（核心循环）
│   │   └── EndState.ts            # 结束状态
│   │
│   ├── services/                  # 服务层
│   │   ├── HexService.ts          # 状态机引擎（主循环）
│   │   └── StrategyService.ts     # 策略服务（决策大脑）
│   │
│   ├── tft/                       # TFT 游戏识别模块
│   │   ├── OcrService.ts          # OCR 文字识别
│   │   ├── ScreenCapture.ts       # 屏幕截图
│   │   ├── TemplateLoader.ts      # 模板加载器
│   │   ├── TemplateMatcher.ts     # 模板匹配
│   │   └── MouseController.ts     # 鼠标控制
│   │
│   ├── lcu/                       # LOL 客户端 API
│   │   └── LCUManager.ts          # LCU REST + WebSocket
│   │
│   ├── lineup/                    # 阵容配置
│   │   ├── LineupLoader.ts        # 阵容加载器
│   │   └── LineupTypes.ts         # 阵容类型定义
│   │
│   ├── TftOperator.ts             # TFT 操作器（统一接口）
│   ├── TFTProtocol.ts             # 游戏协议（坐标、数据）
│   └── utils/                     # 工具类
│       ├── Logger.ts              # 日志
│       ├── SettingsStore.ts       # 配置存储
│       └── HelperTools.ts         # 辅助函数
│
└── public/                        # 静态资源
    └── resources/
        ├── lineups/               # 阵容配置 JSON
        └── assets/images/         # 模板图片
```

---

## 三、状态机流程图

### 3.1 状态转换全景图

```
                              ┌─────────────┐
                              │  IdleState  │ ◄─────────────────────┐
                              │   (空闲)    │                       │
                              └──────┬──────┘                       │
                                     │ start()                      │
                                     ▼                              │
                              ┌─────────────┐                       │
                              │ StartState  │                       │
                              │   (启动)    │                       │
                              └──────┬──────┘                       │
                                     │                              │
                    ┌────────────────┼────────────────┐             │
                    │ (未在游戏中)   │ (已在游戏中)   │             │
                    ▼                │                ▼             │
             ┌─────────────┐         │         ┌─────────────┐      │
             │ LobbyState  │         │         │GameLoading  │      │
             │   (大厅)    │         │         │   State     │      │
             └──────┬──────┘         │         └──────┬──────┘      │
                    │                │                │             │
         ┌──────────┴──────────┐     │                │             │
         │ (匹配成功)          │     │                │             │
         ▼                     │     │                │             │
  ┌─────────────┐              │     │                │             │
  │GameLoading  │              │     │                │             │
  │   State     │◄─────────────┘     │                │             │
  │  (加载中)   │                    │                │             │
  └──────┬──────┘                    │                │             │
         │ (加载完成)                │                │             │
         ▼                           │                │             │
  ┌─────────────┐                    │                │             │
  │ GameStage   │◄───────────────────┴────────────────┘             │
  │   State     │                                                   │
  │ (游戏阶段)  │ ◄──┐                                              │
  └──────┬──────┘    │ (循环执行策略)                               │
         │           │                                              │
         └───────────┘                                              │
         │ (游戏结束)                                               │
         ▼                                                          │
  ┌─────────────┐                                                   │
  │  EndState   │───────────────────────────────────────────────────┘
  │   (结束)    │
  └─────────────┘
```

### 3.2 各状态职责

| 状态 | 文件 | 职责 |
|------|------|------|
| `IdleState` | `states/IdleState.ts` | 待命状态，等待用户点击"启动" |
| `StartState` | `states/StartState.ts` | 初始化检查、备份游戏配置、检测是否已在游戏中 |
| `LobbyState` | `states/LobbyState.ts` | 创建房间、开始匹配、监听对局事件、自动接受匹配 |
| `GameLoadingState` | `states/GameLoadingState.ts` | 轮询检测游戏是否加载完成 |
| `GameStageState` | `states/GameStageState.ts` | **核心**：识别当前阶段，调用策略服务执行决策 |
| `EndState` | `states/EndState.ts` | 清理工作、恢复游戏配置、重置策略服务 |

---

## 四、服务层架构

### 4.1 HexService（状态机引擎）

```
┌─────────────────────────────────────────────────────────────┐
│                       HexService                            │
│                    (状态机引擎/主循环)                       │
├─────────────────────────────────────────────────────────────┤
│  属性:                                                      │
│  - currentState: IState          // 当前状态               │
│  - abortController: AbortController  // 用于停止循环        │
│  - isRunning: boolean            // 运行标志               │
├─────────────────────────────────────────────────────────────┤
│  方法:                                                      │
│  - start()     → 启动主循环                                │
│  - stop()      → 停止主循环（通过 AbortController）         │
│  - getStatus() → 获取当前运行状态                          │
├─────────────────────────────────────────────────────────────┤
│  主循环 runMainLoop(signal):                               │
│                                                             │
│    while (true) {                                          │
│        signal.throwIfAborted();  // 检查停止信号           │
│        nextState = await currentState.action(signal);      │
│        currentState = nextState;                           │
│        await sleep(2000);                                  │
│    }                                                       │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 StrategyService（策略服务/决策大脑）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        StrategyService                              │
│                       (策略服务/决策大脑)                            │
├─────────────────────────────────────────────────────────────────────┤
│  状态管理:                                                          │
│  - currentLineup: LineupConfig       // 当前锁定的阵容              │
│  - candidateLineups: LineupConfig[]  // 候选阵容列表                │
│  - selectionState: LineupSelectionState  // 阵容选择状态            │
│  - currentLevel: number              // 当前人口等级                │
│  - targetChampionNames: Set<string>  // 目标棋子名称集合            │
│  - stageSnapshot: GameStateSnapshot  // 游戏状态快照                │
├─────────────────────────────────────────────────────────────────────┤
│  阵容选择状态枚举:                                                   │
│  - NOT_INITIALIZED  → 未初始化                                      │
│  - PENDING          → 待定中（多阵容等待匹配）                       │
│  - LOCKED           → 已锁定                                        │
├─────────────────────────────────────────────────────────────────────┤
│  核心方法:                                                          │
│  - initialize()           → 初始化，加载用户选中的阵容              │
│  - executeStrategy(stage) → 根据游戏阶段执行对应策略                │
│  - matchAndLockLineup()   → 匹配并锁定最佳阵容                      │
│  - refreshStageSnapshot() → 刷新游戏状态快照                        │
├─────────────────────────────────────────────────────────────────────┤
│  阶段处理方法:                                                      │
│  - handleEarlyGame() → 前期策略（1-1 ~ 1-3，阵容未锁定）            │
│  - handlePve()       → PVE 阶段（打野怪 + 捡球）                    │
│  - handlePvp()       → PVP 阶段（核心运营）                         │
│  - handleCarousel()  → 选秀阶段                                     │
│  - handleAugment()   → 海克斯选择阶段                               │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 阵容选择流程

```
                    ┌─────────────────────┐
                    │   initialize()      │
                    │  读取用户选中阵容   │
                    └──────────┬──────────┘
                               │
              ┌────────────────┴────────────────┐
              │                                 │
              ▼                                 ▼
     ┌─────────────────┐              ┌─────────────────┐
     │  只有 1 个阵容   │              │  有多个候选阵容  │
     └────────┬────────┘              └────────┬────────┘
              │                                 │
              ▼                                 ▼
     ┌─────────────────┐              ┌─────────────────┐
     │   直接锁定      │              │  进入 PENDING   │
     │ LOCKED 状态     │              │     状态        │
     └─────────────────┘              └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │ 前期 PVE 阶段   │
                                      │ handleEarlyGame │
                                      │ 随机买牌+升星   │
                                      └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │ 第一个 PVP 阶段 │
                                      │matchAndLockLineup│
                                      │ 匹配最佳阵容    │
                                      └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │   锁定阵容      │
                                      │  LOCKED 状态    │
                                      └─────────────────┘
```

---

## 五、TftOperator（游戏操作层）

### 5.1 职责概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                         TftOperator                                 │
│                    (TFT 游戏操作统一接口)                            │
├─────────────────────────────────────────────────────────────────────┤
│  识别功能:                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │ getGameStage()  │  │ getShopInfo()   │  │ getBenchInfo()  │     │
│  │ 识别游戏阶段    │  │ 识别商店棋子    │  │ 识别备战席棋子  │     │
│  │ (OCR)          │  │ (OCR+模板匹配)  │  │ (右键+OCR)      │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │getFightBoardInfo│  │ getEquipInfo()  │  │ getLevelInfo()  │     │
│  │ 识别棋盘棋子    │  │ 识别装备栏      │  │ 识别等级经验    │     │
│  │ (右键+OCR)      │  │ (模板匹配)      │  │ (OCR)          │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
├─────────────────────────────────────────────────────────────────────┤
│  操作功能:                                                          │
│  ┌─────────────────┐  ┌─────────────────┐                          │
│  │ buyAtSlot(n)    │  │ getLootOrbs()   │                          │
│  │ 购买商店棋子    │  │ 检测战利品球    │                          │
│  │ (双击)          │  │ (模板匹配)      │                          │
│  └─────────────────┘  └─────────────────┘                          │
├─────────────────────────────────────────────────────────────────────┤
│  依赖的子模块 (src-backend/tft/):                                   │
│  - OcrService        → OCR 文字识别                                │
│  - ScreenCapture     → 屏幕截图                                    │
│  - TemplateLoader    → 模板图片加载                                │
│  - TemplateMatcher   → OpenCV 模板匹配                             │
│  - MouseController   → 鼠标操作 (nut-js)                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 识别方法对比

| 方法 | 是否操作鼠标 | 识别技术 | 可否并行 |
|------|-------------|----------|---------|
| `getGameStage()` | ❌ | OCR | ✅ |
| `getShopInfo()` | ❌ | OCR + 模板匹配 | ✅ |
| `getEquipInfo()` | ❌ | 模板匹配 | ✅ |
| `getLevelInfo()` | ❌ | OCR | ✅ |
| `getCoinCount()` | ⚠️ 失败时点击 | OCR | ✅ |
| `getBenchInfo()` | ✅ 右键点击 | OCR + 模板匹配 | ❌ |
| `getFightBoardInfo()` | ✅ 右键点击 | OCR + 模板匹配 | ❌ |

> **注意**：需要操作鼠标的方法必须串行执行！

### 5.3 金币识别兜底机制

```
┌─────────────────────────────────────────────────────────────┐
│                    getCoinCount() 金币识别                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │ 截图 + OCR 识别金币区域    │
              └───────────────────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │ 结果是纯数字?              │
              └───────────────────────────┘
                     │            │
                    是            否 (可能有弹窗遮挡)
                     │            │
                     ▼            ▼
              ┌──────────┐  ┌─────────────────────────┐
              │ 返回数字  │  │ dismissOverlay()        │
              └──────────┘  │ 点击 SHOP_SLOT_3        │
                            │ 关闭遮挡弹窗             │
                            └─────────────────────────┘
                                        │
                                        ▼
                            ┌─────────────────────────┐
                            │ 重新截图 + OCR          │
                            └─────────────────────────┘
                                        │
                                        ▼
                            ┌───────────────────────────┐
                            │ 成功? 返回数字 : 返回 null │
                            └───────────────────────────┘
```

> **设计说明**：游戏中有时会弹出事件/奖励弹窗遮挡金币区域，导致 OCR 识别失败。
> 此时通过点击商店槽位 3（中间位置）来关闭弹窗，然后重试识别。

---

## 六、IPC 通信架构

### 6.1 通信流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          渲染进程 (React)                           │
│                                                                     │
│    const result = await window.hex.start();                        │
│                              │                                      │
│                              ▼                                      │
│    ┌─────────────────────────────────────────────────────────────┐ │
│    │                    preload.ts                                │ │
│    │  ipcRenderer.invoke(IpcChannel.HEX_START)                   │ │
│    └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ IPC (进程间通信)
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          主进程 (Node.js)                           │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐ │
│    │                      main.ts                                 │ │
│    │  ipcMain.handle(IpcChannel.HEX_START, () => {               │ │
│    │      return hexService.start();                              │ │
│    │  });                                                         │ │
│    └─────────────────────────────────────────────────────────────┘ │
│                              │                                      │
│                              ▼                                      │
│    ┌─────────────────────────────────────────────────────────────┐ │
│    │                    HexService                                │ │
│    │                    StrategyService                           │ │
│    │                    TftOperator                               │ │
│    └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 IPC 频道分类

| 分类 | 频道 | 说明 |
|------|------|------|
| **核心控制** | `HEX_START`, `HEX_STOP`, `HEX_GET_STATUS` | 启动/停止自动下棋 |
| **TFT 操作** | `TFT_BUY_AT_SLOT`, `TFT_GET_SHOP_INFO`, ... | 游戏操作接口 |
| **LCU 客户端** | `LCU_CONNECT`, `LCU_REQUEST`, ... | LOL 客户端 API |
| **阵容管理** | `LINEUP_GET_ALL`, `LINEUP_SET_SELECTED_IDS`, ... | 阵容配置 |
| **配置** | `CONFIG_BACKUP`, `CONFIG_RESTORE` | 游戏配置备份/恢复 |

### 6.3 暴露给前端的 API

```typescript
// preload.ts 暴露的 API 对象

window.hex = {
    start: () => Promise<boolean>,
    stop: () => Promise<void>,
    getStatus: () => Promise<HexStatus>
}

window.tft = {
    buyAtSlot: (slot: number) => Promise<void>,
    getShopInfo: () => Promise<TFTUnit[]>,
    getBenchInfo: () => Promise<BenchUnit[]>,
    getFightBoardInfo: () => Promise<BoardUnit[]>,
    getEquipInfo: () => Promise<IdentifiedEquip[]>,
    getLevelInfo: () => Promise<LevelInfo>
}

window.lcu = {
    connect: () => Promise<boolean>,
    request: (method, path, body?) => Promise<any>,
    // ... 更多 LCU API
}

window.lineup = {
    getAll: () => Promise<LineupConfig[]>,
    getById: (id: string) => Promise<LineupConfig>,
    getSelectedIds: () => Promise<string[]>,
    setSelectedIds: (ids: string[]) => Promise<void>
}
```

---

## 七、游戏阶段循环详解

### 7.1 GameStageState 主循环

```
┌─────────────────────────────────────────────────────────────────────┐
│                     GameStageState.action()                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1. 首次进入时初始化策略服务                                  │   │
│  │    if (!isStrategyInitialized) {                            │   │
│  │        strategyService.initialize();                        │   │
│  │    }                                                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 2. 识别当前游戏阶段                                          │   │
│  │    const stage = await tftOperator.getGameStage();          │   │
│  │                                                              │   │
│  │    可能的结果:                                               │   │
│  │    - PVE (打野怪)                                           │   │
│  │    - PVP (玩家对战)                                         │   │
│  │    - CAROUSEL (选秀)                                        │   │
│  │    - AUGMENT (海克斯)                                       │   │
│  │    - UNKNOWN (无法识别)                                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 3. 执行对应阶段的策略                                        │   │
│  │    await strategyService.executeStrategy(stage);            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 4. 等待后返回自身，继续循环                                  │   │
│  │    await sleep(1000);                                       │   │
│  │    return this;  // 保持在 GameStageState                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 策略执行流程 (executeStrategy)

```
                    ┌─────────────────────┐
                    │ executeStrategy()   │
                    │    传入: stage      │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ 阵容是否已锁定？    │
                    └──────────┬──────────┘
                               │
              ┌────────────────┴────────────────┐
              │ 未锁定 (PENDING)                │ 已锁定 (LOCKED)
              ▼                                 ▼
     ┌─────────────────┐              ┌─────────────────┐
     │ stage == PVE ?  │              │ 刷新人口等级    │
     └────────┬────────┘              │refreshCurrentLevel│
              │                       └────────┬────────┘
     ┌────────┴────────┐                       │
     │ Yes             │ No                    │
     ▼                 ▼                       ▼
┌──────────┐   ┌──────────────┐       ┌─────────────────┐
│handleEarly│   │ stage == PVP │       │ switch(stage)   │
│  Game()  │   │    && 第一次  │       └────────┬────────┘
│前期买牌  │   └──────┬───────┘                │
└──────────┘          │               ┌────────┼────────┬────────┐
                      ▼               │        │        │        │
               ┌──────────────┐       ▼        ▼        ▼        ▼
               │matchAndLock  │   ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
               │   Lineup()   │   │ PVE  │ │ PVP  │ │选秀  │ │海克斯│
               │ 匹配锁定阵容 │   │handle│ │handle│ │handle│ │handle│
               └──────────────┘   │ Pve  │ │ Pvp  │ │Carou-│ │Augme-│
                                  │      │ │      │ │ sel  │ │ nt   │
                                  └──────┘ └──────┘ └──────┘ └──────┘
```

---

## 八、数据流向图

### 8.1 阵容配置加载

```
┌─────────────────┐
│ public/resources│
│   /lineups/     │
│  *.json 文件    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ LineupLoader    │
│ 加载+验证配置   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ SettingsStore   │────►│ StrategyService │
│ selectedLineupIds│     │ 运行时使用阵容  │
└─────────────────┘     └─────────────────┘
```

### 8.2 游戏状态快照

```
┌─────────────────────────────────────────────────────────────────────┐
│                    refreshStageSnapshot()                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1. 并行执行（不需要鼠标）                                    │   │
│  │    Promise.all([                                            │   │
│  │        tftOperator.getShopInfo(),     // 商店              │   │
│  │        tftOperator.getEquipInfo(),    // 装备栏            │   │
│  │        tftOperator.getLevelInfo(),    // 等级              │   │
│  │    ])                                                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 2. 串行执行（需要鼠标操作）                                  │   │
│  │    await tftOperator.getBenchInfo();      // 备战席         │   │
│  │    await tftOperator.getFightBoardInfo(); // 棋盘           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 3. 构建快照对象                                              │   │
│  │    stageSnapshot = {                                        │   │
│  │        benchUnits,   // 备战席 9 槽                         │   │
│  │        boardUnits,   // 棋盘 28 槽                          │   │
│  │        shopUnits,    // 商店 5 槽                           │   │
│  │        equipments,   // 装备栏                              │   │
│  │        level,        // 等级                                │   │
│  │        timestamp,    // 时间戳                              │   │
│  │    }                                                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 九、关键类型定义

### 9.1 游戏阶段枚举

```typescript
// src-backend/TFTProtocol.ts
enum GameStageType {
    PVE = "PVE",           // 打野怪
    PVP = "PVP",           // 玩家对战
    CAROUSEL = "CAROUSEL", // 选秀
    AUGMENT = "AUGMENT",   // 海克斯选择
    UNKNOWN = "UNKNOWN",   // 未知
}
```

### 9.2 阵容选择状态

```typescript
// src-backend/services/StrategyService.ts
enum LineupSelectionState {
    NOT_INITIALIZED = "NOT_INITIALIZED", // 未初始化
    PENDING = "PENDING",                 // 待定中（多阵容等待匹配）
    LOCKED = "LOCKED",                   // 已锁定
}
```

### 9.3 游戏状态快照

```typescript
// src-backend/services/StrategyService.ts
interface GameStateSnapshot {
    benchUnits: (BenchUnit | null)[];    // 备战席 9 槽
    boardUnits: (BoardUnit | null)[];    // 棋盘 28 槽
    shopUnits: (TFTUnit | null)[];       // 商店 5 槽
    equipments: IdentifiedEquip[];       // 装备栏
    level: number;                       // 等级
    currentXp: number;                   // 当前经验
    totalXp: number;                     // 升级所需经验
    timestamp: number;                   // 快照时间戳
}
```

---

## 十、总结

本项目采用 **状态机 + 服务层 + 操作层** 的三层架构：

| 层级 | 模块 | 职责 |
|------|------|------|
| **状态机层** | `states/` | 管理游戏流程各阶段，通过状态转换实现流程控制 |
| **服务层** | `services/` | `HexService` 驱动状态机，`StrategyService` 提供决策逻辑 |
| **操作层** | `TftOperator` + `tft/` | 封装底层的截图、OCR、模板匹配、鼠标操作 |

前后端通过 Electron IPC 通信，`preload.ts` 作为安全桥梁，将后端能力暴露给 React 前端。
